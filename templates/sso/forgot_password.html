{% extends "base.html" %}
{% load static %}

{% block title %}Восстановление пароля{% endblock %}

{% block content %}
    <div class="min-h-screen bg-gray-100 flex items-center justify-center">
        <div class="bg-white p-8 rounded shadow max-w-md w-full">
            <h2 class="text-2xl font-semibold text-center mb-4">Восстановление пароля</h2>

            <form id="forgotForm" class="space-y-4">
                <input type="hidden" id="nonce" value="{{ nonce }}">
                <input type="hidden" id="client_id" value="{{ client_id }}">
                <input type="hidden" id="redirect_uri" value="{{ redirect_uri }}">
                <input type="hidden" id="state" value="{{ state }}">

                <div>
                    <label for="iin" class="block text-sm font-medium text-gray-700">Введите ваш ИИН</label>
                    <input id="iin" name="iin" type="text" required maxlength="12"
                           class="mt-1 block w-full px-4 py-2 border rounded-md shadow-sm border-gray-300 focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                </div>

                <div id="status" class="text-sm text-center text-red-600"></div>

                <button type="submit"
                        class="w-full py-2 px-4 bg-blue-600 text-white rounded-md hover:bg-blue-700 focus:outline-none">
                    Подписать и восстановить
                </button>
            </form>
        </div>
    </div>

    <script src="{% static 'js/ncalayer-client.js' %}"></script>
    <script>
        document.addEventListener("DOMContentLoaded", () => {
            const form = document.getElementById("forgotForm");
            const statusEl = document.getElementById("status");

            function base64urlToBase64(input) {
                return input.replace(/-/g, '+').replace(/_/g, '/').padEnd(Math.ceil(input.length / 4) * 4, '=');
            }

            form.addEventListener("submit", async (e) => {
                e.preventDefault();
                const iin = document.getElementById("iin").value.trim();
                const nonce = document.getElementById("nonce").value;
                const client_id = document.getElementById("client_id").value;
                const redirect_uri = document.getElementById("redirect_uri").value;
                const state = document.getElementById("state").value;

                if (iin.length !== 12) {
                    statusEl.innerText = "Введите корректный ИИН (12 цифр)";
                    return;
                }

                statusEl.innerText = "Подключение к NCALayer...";
                const client = new NCALayerClient();

                try {
                    await client.connect();
                } catch (err) {
                    console.error(err);
                    return statusEl.innerText = "Ошибка подключения к NCALayer";
                }
                const decodedNonce = base64urlToBase64(nonce);
                try {
                    statusEl.innerText = "Подпись...";
                    let signed = await client.basicsSignCMS(
                        NCALayerClient.basicsStorageAll,
                        decodedNonce,
                        NCALayerClient.basicsCMSParamsAttached,
                        NCALayerClient.basicsSignerSignAny
                    );

                    if (signed.includes("-----BEGIN CMS-----")) {
                        signed = signed
                            .replace("-----BEGIN CMS-----", "")
                            .replace("-----END CMS-----", "")
                            .replace(/\r?\n|\r/g, "")
                            .trim();
                    }

                    const resp = await fetch("/api/password/forgot/initiate", {
                        method: "POST",
                        headers: {"Content-Type": "application/json"},
                        body: JSON.stringify({
                            signed_data: signed,
                            nonce,
                            client_id,
                            redirect_uri,
                            state
                        }),
                    });

                    const data = await resp.json();

                    if (resp.ok && data.redirect_url) {
                        window.location.href = data.redirect_url;
                    } else {
                        statusEl.innerText = data.detail || data.error || "Ошибка восстановления";
                    }
                } catch (err) {
                    console.error(err);
                    statusEl.innerText = "Ошибка: " + err.message;
                }
            });
        });
    </script>
{% endblock %}
