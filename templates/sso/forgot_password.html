{% extends "base.html" %}
{% load static %}
{% block title %}Восстановление пароля{% endblock %}

{% block content %}
<div class="min-h-screen bg-gray-100 flex items-center justify-center">
  <div class="bg-white p-8 rounded shadow max-w-md w-full">
    <h2 class="text-2xl font-semibold text-center mb-4">Восстановление пароля</h2>

    <form id="forgotForm" class="space-y-4">
      <div>
        <label for="iin" class="block text-sm font-medium text-gray-700">Введите ваш ИИН</label>
        <input id="iin" name="iin" type="text" required maxlength="12"
               class="mt-1 block w-full px-4 py-2 border rounded-md shadow-sm border-gray-300 focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
      </div>

      <div>
        <label for="new_password" class="block text-sm font-medium text-gray-700">Новый пароль</label>
        <input id="new_password" name="new_password" type="password" required minlength="8"
               class="mt-1 block w-full px-4 py-2 border rounded-md shadow-sm border-gray-300 focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
      </div>

      <div>
        <label for="confirm_password" class="block text-sm font-medium text-gray-700">Повторите пароль</label>
        <input id="confirm_password" name="confirm_password" type="password" required minlength="8"
               class="mt-1 block w-full px-4 py-2 border rounded-md shadow-sm border-gray-300 focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
      </div>

      <div id="status" class="text-sm text-center text-red-600"></div>

      <button type="submit"
              class="w-full py-2 px-4 bg-blue-600 text-white rounded-md hover:bg-blue-700 focus:outline-none">
        Подписать и восстановить
      </button>
    </form>
  </div>
</div>

<script src="{% static 'js/ncalayer-client.js' %}"></script>
<script>
  document.addEventListener("DOMContentLoaded", () => {
    const form = document.getElementById("forgotForm");
    const statusEl = document.getElementById("status");

    const OIDC = {
      CLIENT_ID: "{{ client_id|escapejs }}",
      REDIRECT_URI: "{{ redirect_uri|escapejs }}",
      STATE: "{{ state|escapejs }}",
      NONCE: btoa(Math.random().toString()).substring(0, 16)
    };

    form.addEventListener("submit", async (e) => {
      e.preventDefault();

      const iin = document.getElementById("iin").value.trim();
      const new_password = document.getElementById("new_password").value;
      const confirm_password = document.getElementById("confirm_password").value;

      if (!/^\d{12}$/.test(iin)) {
        statusEl.innerText = "Введите корректный ИИН (12 цифр)";
        return;
      }

      if (new_password.length < 8) {
        statusEl.innerText = "Пароль должен быть не менее 8 символов";
        return;
      }

      if (new_password !== confirm_password) {
        statusEl.innerText = "Пароли не совпадают";
        return;
      }

      const client = new NCALayerClient();

      try {
        statusEl.innerText = "Подключение к NCALayer...";
        await client.connect();
      } catch (err) {
        console.error(err);
        return statusEl.innerText = "Ошибка подключения к NCALayer";
      }

      try {
        statusEl.innerText = "Подпись данных...";
        let signed = await client.basicsSignCMS(
          NCALayerClient.basicsStorageAll,
          OIDC.NONCE,
          NCALayerClient.basicsCMSParamsAttached,
          NCALayerClient.basicsSignerSignAny
        );

        signed = signed.replace("-----BEGIN CMS-----", "")
                       .replace("-----END CMS-----", "")
                       .replace(/\r?\n|\r/g, "").trim();

        const id_token = btoa(JSON.stringify({
          sub: iin,
          name: "user",
          aud: OIDC.CLIENT_ID,
          nonce: OIDC.NONCE,
          redirect_uri: OIDC.REDIRECT_URI,
          state: OIDC.STATE,
          iat: Math.floor(Date.now() / 1000),
          exp: Math.floor(Date.now() / 1000) + 300
        }));

        const resp = await fetch("/api/password/forgot", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            signed_data: signed,
            id_token: id_token,
            new_password: new_password
          }),
        });

        const data = await resp.json();

        if (resp.ok && data.status === "ok") {
          statusEl.classList.remove("text-red-600");
          statusEl.classList.add("text-green-600");
          statusEl.innerText = "Пароль успешно сброшен. Перенаправление...";
          setTimeout(() => {
            window.location.href = OIDC.REDIRECT_URI + "?state=" + encodeURIComponent(OIDC.STATE);
          }, 1500);
        } else {
          console.error(data);
          statusEl.innerText = data.error || data.detail || "Ошибка восстановления";
        }

      } catch (err) {
        console.error(err);
        statusEl.innerText = "Ошибка: " + err.message;
      }
    });
  });
</script>
{% endblock %}
