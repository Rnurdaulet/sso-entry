{% extends "base.html" %}
{% load static %}
{% block title %}Восстановление пароля{% endblock %}

{% block content %}
<div class="min-h-screen bg-gray-100 flex items-center justify-center">
  <div class="bg-white p-8 rounded shadow max-w-md w-full">
    <h2 class="text-2xl font-semibold text-center mb-4">Восстановление пароля</h2>

    <form id="forgotForm" class="space-y-4">
      <div>
        <label for="iin" class="block text-sm font-medium text-gray-700">Введите ваш ИИН</label>
        <input id="iin" name="iin" type="text" required maxlength="12"
               class="mt-1 block w-full px-4 py-2 border rounded-md shadow-sm border-gray-300 focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
      </div>

      <div id="status" class="text-sm text-center text-red-600"></div>

      <button type="submit"
              class="w-full py-2 px-4 bg-blue-600 text-white rounded-md hover:bg-blue-700 focus:outline-none">
        Подписать и восстановить
      </button>
    </form>
  </div>
</div>

<script src="{% static 'js/ncalayer-client.js' %}"></script>
<script>
  document.addEventListener("DOMContentLoaded", () => {
    const form = document.getElementById("forgotForm");
    const statusEl = document.getElementById("status");

    const OIDC = {
      CLIENT_ID: "{{ client_id|escapejs }}",
      REDIRECT_URI: "{{ redirect_uri|escapejs }}",
      STATE: "{{ state|escapejs }}",
      NONCE: btoa(Math.random().toString()).substring(0, 16)
    };

    form.addEventListener("submit", async (e) => {
      e.preventDefault();
      const iin = document.getElementById("iin").value.trim();

      if (iin.length !== 12) {
        statusEl.innerText = "Введите корректный ИИН (12 цифр)";
        return;
      }

      statusEl.innerText = "Подключение к NCALayer...";

      const client = new NCALayerClient();

      try {
        await client.connect();
      } catch (err) {
        console.error(err);
        return statusEl.innerText = "Ошибка подключения к NCALayer";
      }

      try {
        statusEl.innerText = "Подпись данных...";
        let signed = await client.basicsSignCMS(
          NCALayerClient.basicsStorageAll,
          OIDC.NONCE,
          NCALayerClient.basicsCMSParamsAttached,
          NCALayerClient.basicsSignerSignAny
        );

        signed = signed.replace("-----BEGIN CMS-----", "")
                       .replace("-----END CMS-----", "")
                       .replace(/\r?\n|\r/g, "").trim();

        const resp = await fetch("/api/password/forgot", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            signed_data: signed,
            nonce: OIDC.NONCE,
            client_id: OIDC.CLIENT_ID,
            redirect_uri: OIDC.REDIRECT_URI,
            state: OIDC.STATE,
          }),
        });

        const data = await resp.json();

        if (resp.ok && data.redirect_url) {
          window.location.href = data.redirect_url;
        } else {
          statusEl.innerText = data.error || data.detail || "Ошибка восстановления";
        }
      } catch (err) {
        console.error(err);
        statusEl.innerText = "Ошибка: " + err.message;
      }
    });
  });
</script>
{% endblock %}
